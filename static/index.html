<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Pad Station</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f5f5f5;
        font-family: Arial, sans-serif;
      }
      .container {
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 10px 0 rgba(0, 0, 0, 0.2);
        transition: 0.3s;
      }
      .container:hover {
        box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
      }
      .data-panel {
        padding: 20px;
        background: #f7f7f7;
        border-radius: 10px;
        margin-top: 20px;
        transition: all 0.3s ease-in-out;
      }
      .data-panel:hover {
        transform: scale(1.05);
      }
      .data-panel h2 {
        color: #3498db;
        font-size: 18px;
        margin-bottom: 10px;
      }
      .data-panel li {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        animation: fadeIn 1s ease-in;
      }
      .data-panel li:last-child {
        border-bottom: none;
      }
      @keyframes fadeIn {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">Pad Station</h1>
      </div>
      <div class="flex flex-wrap -mx-3">
        <div class="w-full md:w-1/2 px-3 mb-6 md:mb-0">
          <form id="valve-form">
            <div class="mb-4">
              <label
                class="block text-gray-700 font-bold mb-2"
                for="valve-name"
              >
                Valve Name
              </label>
              <select
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="valve-name"
                name="valve-name"
              >
                <option value="fill">Fill</option>
                <option value="dump">Dump</option>
              </select>
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 font-bold mb-2"
                for="valve-state"
              >
                Valve State
              </label>
              <select
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="valve-state"
                name="valve-state"
              >
                <option value="open">Open</option>
                <option value="close">Close</option>
              </select>
            </div>
            <div class="mb-4">
              <button
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                type="submit"
              >
                Actuate Valve
              </button>
            </div>
          </form>
        </div>
        <div class="w-full md:w-1/2 px-3">
          <form id="pressure-form">
            <div class="mb-4">
              <label
                class="block text-gray-700 font-bold mb-2"
                for="sensor-name"
              >
                Sensor Name
              </label>
              <input
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                id="sensor-name"
                name="sensor-name"
                type="text"
                placeholder="Enter sensor name"
              />
            </div>
            <div class="mb-4">
              <button
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                type="submit"
              >
                Get Pressure Data
              </button>
            </div>
          </form>
        </div>
      </div>
      <div class="data-panel p-4 mt-4 bg-gray-100 rounded">
        <h2 class="text-xl font-bold mb-4">Data</h2>
        <ul id="data-list"></ul>
      </div>
    </div>
    <script>
      const valveForm = document.getElementById("valve-form");
      const pressureForm = document.getElementById("pressure-form");
      const dataList = document.getElementById("data-list");

      // Handle form submissions
      valveForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(valveForm);
        const valveName = formData.get("valve-name");
        const valveState = formData.get("valve-state");

        try {
          const response = await fetch(
            `/valve/${valveName}?state=${valveState}`
          );
          if (response.ok) {
            const data = await response.json();
            addDataItem(data);
          } else {
            console.error("Error actuating valve:", response.statusText);
          }
        } catch (error) {
          console.error("Error actuating valve:", error);
        }
      });

      pressureForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const formData = new FormData(pressureForm);
        const sensorName = formData.get("sensor-name");

        const eventSource = new EventSource(`/pressure/${sensorName}`);
        eventSource.onmessage = function (event) {
          const data = JSON.parse(event.data);
          addDataItem(data);
        };
        eventSource.onerror = function (error) {
          console.error("Error getting pressure data:", error);
        };
      });

      // Add data item to the list
      function addDataItem(data) {
        const li = document.createElement("li");
        li.innerHTML = `
            <strong>${
              data.valve_name || data.servo_name || data.sensor_name
            }:</strong> ${data.feedback || data.pressure}
        `;
        dataList.appendChild(li);
      }
    </script>
  </body>
</html>
